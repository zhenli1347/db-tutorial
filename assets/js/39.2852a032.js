(window.webpackJsonp=window.webpackJsonp||[]).push([[39],{373:function(e,o,r){"use strict";r.r(o);var t=r(4),n=Object(t.a)({},(function(){var e=this,o=e._self._c;return o("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[o("h1",{attrs:{id:"mongodb-分片"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#mongodb-分片"}},[e._v("#")]),e._v(" MongoDB 分片")]),e._v(" "),o("h2",{attrs:{id:"分片集群简介"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#分片集群简介"}},[e._v("#")]),e._v(" 分片集群简介")]),e._v(" "),o("p",[e._v("当 MongoDB 需要存储海量数据时，单节点不足以存储全量数据，且可能无法提供令人满意的吞吐量。所以，可以通过 MongoDB 分片机制来支持水平扩展。")]),e._v(" "),o("h3",{attrs:{id:"分片集群特点"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#分片集群特点"}},[e._v("#")]),e._v(" 分片集群特点")]),e._v(" "),o("p",[e._v("对应用完全透明")]),e._v(" "),o("p",[e._v("数据自动均衡")]),e._v(" "),o("p",[e._v("动态扩容")]),e._v(" "),o("p",[e._v("提供三种分片方式")]),e._v(" "),o("h3",{attrs:{id:"分片集群组件"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#分片集群组件"}},[e._v("#")]),e._v(" 分片集群组件")]),e._v(" "),o("p",[e._v("MongoDB 分片集群含以下组件：")]),e._v(" "),o("ul",[o("li",[o("a",{attrs:{href:"https://docs.mongodb.com/manual/core/sharded-cluster-shards/",target:"_blank",rel:"noopener noreferrer"}},[e._v("shard"),o("OutboundLink")],1),e._v("：每个分片包含分片数据的子集。每个分片都可以部署为副本集。")]),e._v(" "),o("li",[o("a",{attrs:{href:"https://docs.mongodb.com/manual/core/sharded-cluster-query-router/",target:"_blank",rel:"noopener noreferrer"}},[e._v("mongos"),o("OutboundLink")],1),e._v("：mongos 充当查询路由器，在客户端应用程序和分片集群之间提供接口。从 MongoDB 4.4 开始，mongos 可以支持 "),o("a",{attrs:{href:"https://docs.mongodb.com/manual/core/sharded-cluster-query-router/#mongos-hedged-reads",target:"_blank",rel:"noopener noreferrer"}},[e._v("hedged reads"),o("OutboundLink")],1),e._v(" 以最大程度地减少延迟。")]),e._v(" "),o("li",[o("a",{attrs:{href:"https://docs.mongodb.com/manual/core/sharded-cluster-config-servers/",target:"_blank",rel:"noopener noreferrer"}},[e._v("config servers"),o("OutboundLink")],1),e._v("：提供集群元数据存储和分片数据分布的映射。")])]),e._v(" "),o("p",[o("img",{attrs:{src:"https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920210057.svg",alt:"img"}})]),e._v(" "),o("h3",{attrs:{id:"分片集群的分布"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#分片集群的分布"}},[e._v("#")]),e._v(" 分片集群的分布")]),e._v(" "),o("p",[o("strong",[e._v("MongoDB 复制集以 collection 为单位")]),e._v("，将数据分布在集群中的各个分片上。最多允许 1024 个分片。")]),e._v(" "),o("p",[e._v("MongoDB 复制集的分片之间数据不重复，只有当所有分片都正常时，才能完整工作。")]),e._v(" "),o("p",[e._v("MongoDB 数据库可以同时包含分片和未分片的集合的 collection。分片 collection 会分布在集群中各节点上。而未分片的 collection 存储在主节点上。每个数据库都有其自己的主节点。")]),e._v(" "),o("p",[e._v("分片和未分片的 collection：")]),e._v(" "),o("p",[o("img",{attrs:{src:"https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920212159.svg",alt:"img"}})]),e._v(" "),o("h3",{attrs:{id:"路由节点-mongos"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#路由节点-mongos"}},[e._v("#")]),e._v(" 路由节点 mongos")]),e._v(" "),o("p",[e._v("要连接 "),o("a",{attrs:{href:"https://docs.mongodb.com/manual/reference/glossary/#term-sharded-cluster",target:"_blank",rel:"noopener noreferrer"}},[e._v("MongoDB 分片集群"),o("OutboundLink")],1),e._v("，必须连接到 "),o("a",{attrs:{href:"https://docs.mongodb.com/manual/reference/glossary/#term-mongos",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("mongos")]),o("OutboundLink")],1),e._v(" 路由器。这包括分片和未分片的 collection。客户端不应该连接到单个分片节点进行读写操作。")]),e._v(" "),o("p",[e._v("连接 "),o("a",{attrs:{href:"https://docs.mongodb.com/manual/reference/program/mongos/#bin.mongos",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("mongos")]),o("OutboundLink")],1),e._v(" 的方式和连接 "),o("a",{attrs:{href:"https://docs.mongodb.com/manual/reference/program/mongod/#bin.mongod",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("mongod")]),o("OutboundLink")],1),e._v(" 相同，例如通过 "),o("a",{attrs:{href:"https://docs.mongodb.com/manual/reference/program/mongo/#bin.mongo",target:"_blank",rel:"noopener noreferrer"}},[o("code",[e._v("mongo")]),o("OutboundLink")],1),e._v(" shell 或 "),o("a",{attrs:{href:"https://docs.mongodb.com/drivers/?jump=docs",target:"_blank",rel:"noopener noreferrer"}},[e._v("MongoDB 驱动程序"),o("OutboundLink")],1),e._v("。")]),e._v(" "),o("p",[o("img",{attrs:{src:"https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920212157.svg",alt:"img"}})]),e._v(" "),o("p",[e._v("路由节点的作用：")]),e._v(" "),o("ul",[o("li",[e._v("提供集群的单一入口")]),e._v(" "),o("li",[e._v("转发应用端请求")]),e._v(" "),o("li",[e._v("选择合适数据节点进行读写")]),e._v(" "),o("li",[e._v("合并多个数据节点的返回")])]),e._v(" "),o("p",[e._v("一般，路由节点 mongos 建议至少 2 个。")]),e._v(" "),o("h2",{attrs:{id:"分片-key"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#分片-key"}},[e._v("#")]),e._v(" 分片 Key")]),e._v(" "),o("p",[e._v("MongoDB 使用分片 Key 在各个分片之间分发 collection 的 document。分片 Key 由 document 中的一个或多个字段组成。")]),e._v(" "),o("ul",[o("li",[o("p",[e._v("从 MongoDB 4.4 开始，分片 collection 中的 document 可能缺少分片 Key 字段。在跨分片分布文档时，缺少分片 Key 字段将被视为具有空值，但在路由查询时则不会。")])]),e._v(" "),o("li",[o("p",[e._v("在 MongoDB 4.2 及更早版本中，分片 Key 字段必须在每个 document 中存在一个分片 collection。")])])]),e._v(" "),o("p",[e._v("在分片 collection 时选择分片 Key。")]),e._v(" "),o("ul",[o("li",[e._v("从 MongoDB 4.4 开始，您可以通过在现有 Key 中添加一个或多个后缀字段来优化 collection 的分片 Key。")]),e._v(" "),o("li",[e._v("在 MongoDB 4.2 和更低版本中，无法在分片后更改分片 Key 的选择。")])]),e._v(" "),o("p",[e._v("document 的分片键值决定了其在各个分片中的分布")]),e._v(" "),o("ul",[o("li",[e._v("从 MongoDB 4.2 开始，除非您的分片 Key 字段是不可变的_id 字段，否则您可以更新 document 的分片键值。")]),e._v(" "),o("li",[e._v("在 MongoDB 4.0 及更低版本中，文档的分片 Key 字段值是不可变的。")])]),e._v(" "),o("p",[e._v("分片 Key 索引：要对已填充的 collection 进行分片，该 collection 必须具有以分片 Key 开头的索引。分片一个空 collection 时，如果该 collection 还没有针对指定分片 Key 的适当索引，则 MongoDB 会创建支持索引。")]),e._v(" "),o("p",[e._v("分片 Key 策略：分片 Key 的选择会影响分片集群的性能，效率和可伸缩性。分片 Key 及其后备索引的选择也会影响集群可以使用的分片策略。")]),e._v(" "),o("p",[e._v("MongoDB 分区将数据分片。每个分块都有基于分片 Key 的上下限。")]),e._v(" "),o("p",[e._v("为了在整个集群中的所有分片上实现块的均匀分布，均衡器在后台运行，并在各分片上迁移块。")]),e._v(" "),o("h2",{attrs:{id:"分片策略"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#分片策略"}},[e._v("#")]),e._v(" 分片策略")]),e._v(" "),o("p",[e._v("MongoDB 支持两种分片策略：Hash 分片和范围分片。")]),e._v(" "),o("h3",{attrs:{id:"hash-分片"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#hash-分片"}},[e._v("#")]),e._v(" Hash 分片")]),e._v(" "),o("p",[e._v("Hash 分片策略会先计算分片 Key 字段值的哈希值；然后，根据分片键值为每个 "),o("a",{attrs:{href:"https://docs.mongodb.com/manual/reference/glossary/#term-chunk",target:"_blank",rel:"noopener noreferrer"}},[e._v("chunk"),o("OutboundLink")],1),e._v(" 分配一个范围。")]),e._v(" "),o("blockquote",[o("p",[e._v("注意：使用哈希索引解析查询时，MongoDB 会自动计算哈希值，应用程序不需要计算哈希。")])]),e._v(" "),o("p",[o("img",{attrs:{src:"https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920213343.svg",alt:"img"}})]),e._v(" "),o("p",[e._v("尽管分片 Key 范围可能是“接近”的，但它们的哈希值不太可能在同一 "),o("a",{attrs:{href:"https://docs.mongodb.com/manual/reference/glossary/#term-chunk",target:"_blank",rel:"noopener noreferrer"}},[e._v("chunk"),o("OutboundLink")],1),e._v(" 上。基于 Hash 的数据分发有助于更均匀的数据分布，尤其是在分片 Key 单调更改的数据集中。")]),e._v(" "),o("p",[e._v("但是，Hash 分片意味着对分片 Key 做范围查询时不太可能针对单个分片，从而导致更多的集群范围内的广播操作。")]),e._v(" "),o("h3",{attrs:{id:"范围分片"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#范围分片"}},[e._v("#")]),e._v(" 范围分片")]),e._v(" "),o("p",[e._v("范围分片根据分片 Key 值将数据划分为多个范围。然后，根据分片 Key 值为每个 "),o("a",{attrs:{href:"https://docs.mongodb.com/manual/reference/glossary/#term-chunk",target:"_blank",rel:"noopener noreferrer"}},[e._v("chunk"),o("OutboundLink")],1),e._v(" 分配一个范围。")]),e._v(" "),o("p",[o("img",{attrs:{src:"https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920213345.svg",alt:"img"}})]),e._v(" "),o("p",[e._v("值比较近似的一系列分片 Key 更有可能驻留在同一 "),o("a",{attrs:{href:"https://docs.mongodb.com/manual/reference/glossary/#term-chunk",target:"_blank",rel:"noopener noreferrer"}},[e._v("chunk"),o("OutboundLink")],1),e._v(" 上。范围分片的效率取决于选择的分片 Key。分片 Key 考虑不周全会导致数据分布不均，这可能会削弱分片的某些优势或导致性能瓶颈。")]),e._v(" "),o("h2",{attrs:{id:"分片集群中的区域"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#分片集群中的区域"}},[e._v("#")]),e._v(" 分片集群中的区域")]),e._v(" "),o("p",[e._v("区域可以提高跨多个数据中心的分片集群的数据局部性。")]),e._v(" "),o("p",[e._v("在分片集群中，可以基于分片 Key 创建分片数据"),o("a",{attrs:{href:"https://docs.mongodb.com/manual/reference/glossary/#term-zone",target:"_blank",rel:"noopener noreferrer"}},[e._v("区域"),o("OutboundLink")],1),e._v("。可以将每个区域与集群中的一个或多个分片关联。分片可以与任意数量的区域关联。在平衡的集群中，MongoDB 仅将区域覆盖的 "),o("a",{attrs:{href:"https://docs.mongodb.com/manual/reference/glossary/#term-chunk",target:"_blank",rel:"noopener noreferrer"}},[e._v("chunk"),o("OutboundLink")],1),e._v(" 迁移到与该区域关联的分片。")]),e._v(" "),o("p",[e._v("每个区域覆盖一个或多个分片 Key 值范围。区域覆盖的每个范围始终包括其上下边界。")]),e._v(" "),o("p",[o("img",{attrs:{src:"https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920214854.svg",alt:"img"}})]),e._v(" "),o("p",[e._v("在定义要覆盖的区域的新范围时，必须使用分片 Key 中包含的字段。如果使用复合分片 Key，则范围必须包含分片 Key 的前缀。")]),e._v(" "),o("p",[e._v("选择分片 Key 时，应考虑将来可能使用的区域。")]),e._v(" "),o("h2",{attrs:{id:"参考资料"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[e._v("#")]),e._v(" 参考资料")]),e._v(" "),o("ul",[o("li",[o("strong",[e._v("官方")]),e._v(" "),o("ul",[o("li",[o("a",{attrs:{href:"https://www.mongodb.com/",target:"_blank",rel:"noopener noreferrer"}},[e._v("MongoDB 官网"),o("OutboundLink")],1)]),e._v(" "),o("li",[o("a",{attrs:{href:"https://github.com/mongodb/mongo",target:"_blank",rel:"noopener noreferrer"}},[e._v("MongoDB Github"),o("OutboundLink")],1)]),e._v(" "),o("li",[o("a",{attrs:{href:"https://university.mongodb.com/",target:"_blank",rel:"noopener noreferrer"}},[e._v("MongoDB 官方免费教程"),o("OutboundLink")],1)])])]),e._v(" "),o("li",[o("strong",[e._v("教程")]),e._v(" "),o("ul",[o("li",[o("a",{attrs:{href:"https://www.runoob.com/mongodb/mongodb-tutorial.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("MongoDB 教程"),o("OutboundLink")],1)]),e._v(" "),o("li",[o("a",{attrs:{href:"https://time.geekbang.org/course/intro/100040001",target:"_blank",rel:"noopener noreferrer"}},[e._v("MongoDB 高手课"),o("OutboundLink")],1)])])])])])}),[],!1,null,null,null);o.default=n.exports}}]);